#!/bin/bash
# Industrial-grade RAM screening script - GSAT memory-focused version
# Optimized for Supermicro hosts with AMI BIOS (up to 8 DIMMs)

############################
# 0. Pre-checks & Safety
############################
export TERM=linux
LOG_DIR="/root/test_logs"
mkdir -p $LOG_DIR
GSAT_LOG="$LOG_DIR/gsat_$(date +%Y%m%d_%H%M%S).log"

if [ "$EUID" -ne 0 ]; then
    echo "Please run this script as root."
    exit 1
fi

for cmd in stressapptest dmidecode curl; do
    command -v $cmd >/dev/null 2>&1 || { echo "$cmd not installed. Aborting."; exit 1; }
done

rm -f /tmp/temp_fail
trap 'kill $TEMP_PID 2>/dev/null; kill $GSAT_PID 2>/dev/null' EXIT

############################
# 1. Initialize screen
############################

setterm -background blue -foreground white -clear all
echo "System booted successfully, scanning hardware..."

############################
# 2. Gather hardware info
############################

CPU_MODEL=$(lscpu | awk -F: '/Model name/ {print $2}' | xargs)

MEM_INFO=$(dmidecode -t memory)

MEM_COUNT=$(echo "$MEM_INFO" | grep -E "Size: [0-9]+" | wc -l)
MEM_TYPE=$(echo "$MEM_INFO" | awk -F: '/Type:/ && !/Unknown/ {print $2; exit}' | xargs)
MEM_SPEED=$(echo "$MEM_INFO" | awk -F: '/Speed:/ && !/Unknown/ {print $2; exit}' | xargs)
ECC_STATUS=$(echo "$MEM_INFO" | awk -F: '/Error Correction Type:/ {print $2; exit}' | xargs)

TOTAL_MEM=$(awk '/MemTotal/ {printf "%.0f GB", $2/1024/1024}' /proc/meminfo)

if [ "$MEM_COUNT" -eq 0 ]; then
    echo "No DIMMs detected. Aborting."
    exit 1
fi

############################
# 3. Calculate test memory
############################

FREE_KB=$(awk '/MemAvailable/ {print $2}' /proc/meminfo)
TEST_MB=$((FREE_KB * 90 / 100 / 1024))

[ "$TEST_MB" -lt 1024 ] && TEST_MB=1024

MEM_THREADS=$(( $(nproc) / 2 ))
[ "$MEM_THREADS" -lt 4 ] && MEM_THREADS=4

echo "CPU: $CPU_MODEL"
echo "Memory: $MEM_COUNT DIMMs | Type: $MEM_TYPE | Speed: $MEM_SPEED | Total: $TOTAL_MEM | ECC: $ECC_STATUS"
echo "Test target: ${TEST_MB} MB | Memory threads: $MEM_THREADS"
sleep 2

############################
# 4. Temperature monitoring
############################

if command -v ipmitool >/dev/null 2>&1; then
    echo "Using IPMI for temperature monitoring."
    TEMP_CMD="ipmitool sensor | awk '/CPU Temp/ {print \$4}' | sort -n | tail -1"
else
    sensors >/dev/null 2>&1
    TEMP_CMD="sensors -u 2>/dev/null | awk '/temp[0-9]+_input:/ {print \$2}' | sort -n | tail -1"
fi

TEMP_THRESHOLD=88

############################
# 5. Baseline kernel errors
############################

dmesg | grep -iE "ECC|MCE|Hardware Error" > /tmp/pre_test_errors.log

############################
# 6. Run GSAT
############################

setterm -background black -foreground white -clear all
echo "Running memory screening test (GSAT)... DO NOT power off."
echo "Duration: 60 minutes"

# Start temperature monitor
(
while true; do
    MAX_TEMP=$(eval $TEMP_CMD 2>/dev/null)
    MAX_TEMP_INT=${MAX_TEMP%.*}
    [ -z "$MAX_TEMP_INT" ] && MAX_TEMP_INT=0

    if [ "$MAX_TEMP_INT" -gt "$TEMP_THRESHOLD" ]; then
        echo "Temperature too high: ${MAX_TEMP_INT}Â°C"
        touch /tmp/temp_fail
        kill $GSAT_PID 2>/dev/null
        exit 1
    fi
    sleep 5
done
) &

TEMP_PID=$!

# Run GSAT in background
stressapptest \
    -M ${TEST_MB} \
    -s 3600 \
    -W \
    -m ${MEM_THREADS} \
    --cc_test \
    > $GSAT_LOG 2>&1 &

GSAT_PID=$!
wait $GSAT_PID
GSAT_EXIT=$?

kill $TEMP_PID 2>/dev/null
wait $TEMP_PID 2>/dev/null

[ -f /tmp/temp_fail ] && GSAT_EXIT=1

############################
# 7. Post-test kernel errors
############################

dmesg | grep -iE "ECC|MCE|Hardware Error" > /tmp/post_test_errors.log
NEW_ERRORS=$(diff /tmp/pre_test_errors.log /tmp/post_test_errors.log | grep '^>' | wc -l)

# Safer GSAT error detection
ERROR_COUNT=$(grep -iE "FAIL|ERROR" /tmp/gsat.log | grep -vi "0 errors" | wc -l)

############################
# 8. Prepare report info
############################

HOST_ID=$(hostname)
CPU_SN=$(grep -m1 Serial /proc/cpuinfo | awk '{print $3}')
[ -z "$CPU_SN" ] && CPU_SN="N/A"

############################
# 9. Final Result
############################

if [ "$GSAT_EXIT" -eq 0 ] && [ "$ERROR_COUNT" -eq 0 ] && [ "$NEW_ERRORS" -eq 0 ]; then

    setterm -background green -foreground white -clear all
    echo -e "\n\n"
    echo "=========================================="
    echo "TEST PASS - Memory Stable"
    echo "DIMMs: $MEM_COUNT | ECC: $ECC_STATUS"
    echo "=========================================="

    curl -s -X POST http://YOUR_SERVER_IP:8080/report \
        -d "host=$HOST_ID&result=PASS&cpu_sn=$CPU_SN&mem_count=$MEM_COUNT&ecc_status=$ECC_STATUS" \
        || echo "Report server unreachable."

    sleep 10
    poweroff

else

    setterm -background red -foreground white -clear all
    echo -e "\n\n"
    echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
    echo "TEST FAIL - Memory Issues Detected"
    echo "GSAT Exit: $GSAT_EXIT"
    echo "GSAT Errors: $ERROR_COUNT"
    echo "New Kernel Errors: $NEW_ERRORS"
    echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
    echo
    tail -n 20 /tmp/gsat.log
    echo
    diff /tmp/pre_test_errors.log /tmp/post_test_errors.log | grep '^>' || echo "No new kernel errors."

    #curl -s -X POST http://YOUR_SERVER_IP:8080/report \
    #    -d "host=$HOST_ID&result=FAIL&cpu_sn=$CPU_SN&mem_count=$MEM_COUNT&ecc_status=$ECC_STATUS&log=$(tail -n 50 /tmp/gsat.log | base64 -w 0)" \
    #    || echo "Report server unreachable."

    for i in {1..10}; do echo -e "\a" > /dev/tty1; sleep 0.5; done
    while true; do sleep 60; done

fi
